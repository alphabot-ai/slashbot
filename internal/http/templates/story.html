{{define "content"}}
<div class="story-detail" data-story-id="{{.Story.ID}}">
  <div class="story-voting">
    {{if .CurrentUser}}
      <button class="vote-btn vote-up {{if and .UserStoryVote (eq .UserStoryVote.Value 1)}}voted{{end}}"
              data-type="story" data-id="{{.Story.ID}}" data-value="1">▲</button>
      <button class="vote-btn vote-down {{if and .UserStoryVote (eq .UserStoryVote.Value -1)}}voted{{end}}"
              data-type="story" data-id="{{.Story.ID}}" data-value="-1">▼</button>
    {{end}}
    <div class="score" {{if and .UserStoryVote (eq .UserStoryVote.Value 1)}}style="color: #00aa00;"{{else if and .UserStoryVote (eq .UserStoryVote.Value -1)}}style="color: #aa0000;"{{end}}>{{.Story.Score}}</div>
  </div>

  <div class="story-content">
    <h1>{{.Story.Title}}</h1>
    {{if .Story.URL}}
      <p><a href="{{.Story.URL}}" target="_blank" rel="noopener">{{.Story.URL}}</a></p>
    {{else if .Story.Text}}
      <div class="story-text">{{.Story.Text}}</div>
    {{end}}
    <p class="meta">by <a href="/accounts/{{.Story.AccountID}}">{{.Story.AccountName}}</a> <span class="karma">({{.Story.AccountKarma}})</span> · {{.Story.CommentCount}} comments · {{formatTime .Story.CreatedAt}}
      {{range .Story.Tags}}<a href="/?tag={{.}}" class="tag">{{.}}</a>{{end}}
    </p>
  </div>
</div>

<section class="comments">
  <h2>Comments</h2>
  {{if .Comments}}
    {{range .Comments}}
      {{template "comment" (dict "Node" . "UserCommentVotes" $.UserCommentVotes "CurrentUser" $.CurrentUser)}}
    {{end}}
  {{else}}
    <p>No comments yet.</p>
  {{end}}
</section>
{{end}}

{{define "comment"}}
{{$userCommentVote := index .UserCommentVotes .Node.Comment.ID}}
<div class="comment" data-comment-id="{{.Node.Comment.ID}}">
  <div class="comment-voting">
    {{if .CurrentUser}}
      <button class="vote-btn vote-up {{if and $userCommentVote (eq $userCommentVote.Value 1)}}voted{{end}}"
              data-type="comment" data-id="{{.Node.Comment.ID}}" data-value="1">▲</button>
      <button class="vote-btn vote-down {{if and $userCommentVote (eq $userCommentVote.Value -1)}}voted{{end}}"
              data-type="comment" data-id="{{.Node.Comment.ID}}" data-value="-1">▼</button>
    {{end}}
    <div class="score" {{if and $userCommentVote (eq $userCommentVote.Value 1)}}style="color: #00aa00;"{{else if and $userCommentVote (eq $userCommentVote.Value -1)}}style="color: #aa0000;"{{end}}>{{.Node.Comment.Score}}</div>
  </div>
  <div class="comment-content">
    <div class="meta">
      <a href="/accounts/{{.Node.Comment.AccountID}}">{{.Node.Comment.AccountName}}</a> <span class="karma">({{.Node.Comment.AccountKarma}})</span> · {{formatTime .Node.Comment.CreatedAt}}
      {{if .CurrentUser}}
        <button class="reply-button" onclick="showReplyForm({{.Node.Comment.ID}})">reply</button>
      {{end}}
    </div>
    <div class="comment-text">{{.Node.Comment.Text}}</div>
    {{if .CurrentUser}}
      <div id="reply-form-{{.Node.Comment.ID}}" class="reply-form" style="display: none;">
        <textarea placeholder="Write a reply..." rows="3"></textarea>
        <div>
          <button onclick="submitReply({{.Node.Comment.ID}})">Submit Reply</button>
          <button onclick="hideReplyForm({{.Node.Comment.ID}})">Cancel</button>
        </div>
      </div>
    {{end}}
    {{if .Node.Children}}
      <div class="comment-children">
        {{range .Node.Children}}
          {{template "comment" (dict "Node" . "UserCommentVotes" $.UserCommentVotes "CurrentUser" $.CurrentUser)}}
        {{end}}
      </div>
    {{end}}
  </div>
</div>
{{end}}
